# iaw - Ivo's Analytical Workbench

R package providing ~145 utility functions for data manipulation, regression,
plotting, and parallel computing. All functions live in the `iaw` environment
and are called as `iaw$func()`.

## Architecture

### Two execution modes

1. **Package mode** (`library(iaw)`) - standard R package installed via `make install`.
   `R/zzz.R:.onLoad()` sources every `.R` file from `inst/lib/` into the `iaw` env.

2. **Rprofile mode** (`source("Rprofile.R")`) - interactive/script use.
   `Rprofile.R` Section 8 sources `.R` files, byte-compiles with `cmpfun()`,
   caches result in `library.Rdata`. When source files change, it also
   runs `make install` automatically so `?help` stays current.

### Key directories

- Root `*.R` files - the actual function source (145 files). This is the
  single source of truth. **Do not put function code in `R/`.**
- `R/` - only `zzz.R` (package loader) and `iaw-package.R` (package doc).
- `inst/lib/` - copies of root `.R` files, created by `make lib`.
  Generated; do not edit.
- `man/` - `.Rd` man pages generated by `tools/generate-man.R`, plus
  hand-written `man/iaw.Rd` (the `?iaw` overview page).
  Checked into git (small files). Regenerate with `make man`.
  **Do not edit generated files; edit the roxygen comments in root `.R` files.**
- `tools/` - build scripts (`generate-man.R`).
- `tests/testthat/` - test suite run via `testthat`.
- `Rold/` - archived/obsolete code. Ignore.

### Function definition patterns

```r
# Standard function
iaw$func <- function(arg1, arg2 = default) { ... }

# Closure factory (chatter, msg, sink)
make_func <- function() { ... ; return(inner_fun) }
iaw$func <- make_func()

# Alias
iaw$fwrite <- iaw$write.csv

# Operator (not in iaw env, exported directly)
`%and%` <- function(e1, e2) { ... }
```

### Roxygen documentation

Every `.R` file has `#'` roxygen-style comments with `@name`, `@param`,
`@return`, `@family`, `@examples`, `@export`, etc. These are parsed by
`tools/generate-man.R` (not roxygen2) to produce `man/*.Rd` files.

Every function has 2-4 `@examples` showing basic usage and edge cases.
Use `\dontrun{}` for side-effectful examples (file I/O, plotting).

Multi-function files use `@rdname` to group into a single man page
(e.g., `mc.by.R` has `mc.by`, `mc.by.cache`, `mc.by.cripple.toggle`,
`mc.by.data.frame`).

The generator handles S3 methods (emits `\method{print}{olm}`) and
uses actual parameter names for operator usage lines.

## Build commands

```
make lib       # copy .R files to inst/lib/
make man       # generate man pages from roxygen comments
make build     # R CMD build (depends on lib + man)
make install   # R CMD INSTALL (depends on lib + man)
make check     # R CMD check (expect 1 WARNING: code/doc mismatch from iaw$ pattern)
make clean     # remove inst/lib/, .Rcheck/, tarballs
```

## Testing

```
Rscript -e 'testthat::test_dir("tests/testthat")'
```

Tests live in `tests/testthat/`. The setup file (`tests/testthat/setup.R`)
loads iaw before tests run.

## Key files

- `DESCRIPTION` - package metadata, dependencies
- `NAMESPACE` - exports `iaw`, `%and%`, `%or%`, `%inrange%`, `print.olm` S3 method
- `.Rbuildignore` - excludes root `.R` files from the package tarball
  (they go via `inst/lib/` instead)
- `Rprofile.R` - interactive/script mode loader (not part of the package)
- `README.md` - GitHub landing page with installation instructions

## R CMD check

`make check` produces 1 WARNING (code/documentation mismatches) because
all ~145 functions live in the `iaw` environment rather than as top-level
exports. This is architectural and expected. Everything else should be OK.

## Conventions

- Functions use `stopifnot()` for input validation
- `@family` tags group related functions (parallel, io, statistics, regression, etc.)
- Closure factories are documented via `@param` on the outer block;
  the `make_*` function name is internal, not user-facing
- `@keywords internal` marks private helpers (e.g., `iaw$.mkusefullist`)
- Internal state variables use dot-prefix: `iaw$.mc.cripple`, `iaw$.mc.by.cache`
- Use `assign()` not `<<-` to modify `iaw` env bindings (avoids locked-binding
  errors in package mode where the namespace is sealed)
